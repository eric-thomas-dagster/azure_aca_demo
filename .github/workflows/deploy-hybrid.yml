name: Deploy to Dagster+ Hybrid (ACR)

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened, closed]

env:
  DAGSTER_CLOUD_ORGANIZATION: ${{ secrets.DAGSTER_CLOUD_ORGANIZATION }}
  IMAGE_REGISTRY: ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io

jobs:
  dagster-cloud-deploy:
    runs-on: ubuntu-latest
    name: Deploy to Dagster+ Hybrid

    steps:
      - name: Pre-run check
        id: prerun
        run: echo "result=${{ github.event_name == 'pull_request' && github.event.action == 'closed' && 'skip' || 'continue' }}" >> $GITHUB_OUTPUT

      - name: Checkout code
        if: steps.prerun.outputs.result != 'skip'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}

      - name: Validate dagster_cloud.yaml
        if: steps.prerun.outputs.result != 'skip'
        run: |
          if [ ! -f "dagster_cloud.yaml" ]; then
            echo "Error: dagster_cloud.yaml not found"
            exit 1
          fi
          cat dagster_cloud.yaml

      - name: Initialize Dagster Cloud build session
        if: steps.prerun.outputs.result != 'skip'
        id: ci-init
        uses: dagster-io/dagster-cloud-action/actions/utils/ci-init@v1.12.6
        with:
          deployment: ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || 'prod' }}
        env:
          DAGSTER_CLOUD_API_TOKEN: ${{ secrets.DAGSTER_CLOUD_API_TOKEN }}

      - name: Set up Docker Buildx
        if: steps.prerun.outputs.result != 'skip'
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        if: steps.prerun.outputs.result != 'skip'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image to ACR
        if: steps.prerun.outputs.result != 'skip'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io/azure-demo:${{ github.sha }}
            ${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io/azure-demo:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            deployment=${{ steps.ci-init.outputs.deployment }}

      - name: Update build session with Docker image
        if: steps.prerun.outputs.result != 'skip'
        uses: dagster-io/dagster-cloud-action/actions/utils/dagster-cloud-cli@v1.12.6
        with:
          command: "ci set-build-output --location-name=azure-pipeline --image-tag=${{ github.sha }}"
        env:
          DAGSTER_CLOUD_API_TOKEN: ${{ secrets.DAGSTER_CLOUD_API_TOKEN }}

      - name: Deploy to Dagster Cloud
        if: steps.prerun.outputs.result != 'skip'
        uses: dagster-io/dagster-cloud-action/actions/utils/dagster-cloud-cli@v1.12.6
        with:
          command: "ci deploy --organization=${{ secrets.DAGSTER_CLOUD_ORGANIZATION }} --deployment=${{ steps.ci-init.outputs.deployment }}"
        env:
          DAGSTER_CLOUD_API_TOKEN: ${{ secrets.DAGSTER_CLOUD_API_TOKEN }}
